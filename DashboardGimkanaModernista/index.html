<!doctype html>
<html lang="ca">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panell de resultats de la Gimkana Modernista</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, .08), transparent 30%), radial-gradient(circle at 80% 0%, rgba(255, 255, 255, .08), transparent 30%), linear-gradient(135deg, #0d1b2a, #0b2f53 60%, #103a4f);
      --card: rgba(255, 255, 255, .08);
      --border: rgba(255, 255, 255, .12);
      --text: #e9f0f7;
      --muted: #9ab3c9;
      --accent-3r: #3bd6c6;
      --accent-4t: #f2a93b;
      --shadow: 0 25px 50px rgba(0, 0, 0, .35);
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      min-height: 100vh;
      color: var(--text);
      font-family: "Space Grotesk", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      display: flex;
      flex-direction: column;
    }

    .page {
      flex: 1;
      padding: 8px clamp(16px, 4vw, 60px) 110px;
      position: relative;
      overflow: hidden;
    }

    .glow {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at 30% 40%, rgba(59, 214, 198, .16), transparent 35%), radial-gradient(circle at 70% 20%, rgba(242, 169, 59, .16), transparent 30%);
      filter: blur(40px);
      z-index: 0;
    }

    header {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 260px;
    }

    .logo-mark {
      height: 110px;
      width: auto;
      filter: drop-shadow(0 6px 20px rgba(0, 0, 0, .25));
    }

    .eyebrow {
      text-transform: uppercase;
      letter-spacing: .16em;
      font-size: 10px;
      color: var(--muted);
      margin: 0 0 6px;
    }

    h1 {
      margin: 0;
      font-size: clamp(24px, 2.9vw, 37px);
      line-height: 1.1;
    }

    .subtitle {
      margin: 2px 0 0;
      color: var(--muted);
      font-size: 14px;
    }

    .badge {
      background: rgba(255, 255, 255, .08);
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: var(--shadow);
      align-self: flex-start;
    }

    .hidden-icon {
      display: none !important;
    }

    .board {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 22px;
      margin-top: 2px;
    }

    .col {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 13px 18px 10px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    .col-head {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--muted);
      box-shadow: 0 0 12px rgba(0, 0, 0, .25);
    }

    .col-title {
      font-size: 17px;
      font-weight: 700;
      letter-spacing: .02em;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 7px;
    }

    .item {
      display: grid;
      grid-template-columns: 48px 1fr auto;
      align-items: center;
      gap: 9px;
      padding: 7px 11px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, .04);
    }

    .item.pulse {
      animation: pulseGlow 1.1s ease;
      position: relative;
    }

    .rank {
      width: 30px;
      height: 30px;
      display: grid;
      place-items: center;
      border-radius: 10px;
      font-weight: 700;
      font-size: 12px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255, 255, 255, .05);
    }

    .details {
      display: flex;
      align-items: center;
      gap: 12px;
      min-height: 36px;
    }

    .name {
      font-weight: 800;
      font-size: 28px;
      letter-spacing: 0.01em;
    }

    .bar {
      position: relative;
      flex: 1;
      height: 13px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .1);
      overflow: hidden;
      min-width: 120px;
    }

    .fill {
      position: absolute;
      inset: 0;
      width: 0;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255, 255, 255, .7), rgba(255, 255, 255, .4));
      transform-origin: left;
      transition: width .6s ease;
    }

    @keyframes pulseGlow {
      0% {
        box-shadow: 0 0 0 0 var(--pulse-color, rgba(255, 255, 255, .6));
        transform: translateY(0);
      }

      50% {
        box-shadow: 0 0 0 18px transparent;
        transform: translateY(-4px);
      }

      100% {
        box-shadow: 0 0 0 0 transparent;
        transform: translateY(0);
      }
    }

    .score {
      font-weight: 800;
      font-size: 20px;
      min-width: 80px;
      text-align: right;
      display: flex;
      justify-content: flex-end;
      align-items: flex-end;
      gap: 4px;
    }

    .score .pts {
      font-size: 10px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .confetti {
      position: fixed;
      top: -20px;
      width: 10px;
      height: 18px;
      opacity: 0.9;
      border-radius: 3px;
      animation: confettiFall 1.2s ease-out forwards;
      pointer-events: none;
      z-index: 5;
    }

    @keyframes confettiFall {
      0% {
        transform: translate3d(var(--x, 0), 0, 0) rotate(0deg);
      }

      100% {
        transform: translate3d(var(--x, 0), 110vh, 0) rotate(320deg);
      }

      to {
        opacity: 0;
      }
    }

    .empty {
      color: var(--muted);
      font-size: 12px;
      padding: 6px 12px;
    }

    .error {
      color: #ffb4b4;
      margin-top: 16px;
      white-space: pre-wrap;
      font-size: 12px;
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 10px 20px;
      background: var(--bg);
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 9px;
      border-top: 1px solid var(--border);
      backdrop-filter: blur(6px);
    }

    footer a {
      color: var(--text);
      text-decoration: none;
      font-weight: 700;
    }

    @media (max-width:720px) {
      .item {
        grid-template-columns: 40px 1fr;
      }

      .score {
        justify-self: end;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="glow"></div>
    <header>
      <div class="header-left">
        <img src="dashboard.svg" alt="Dashboard" class="logo-mark" loading="lazy">
        <div style="flex: 1;">
          <h1>Panell de resultats de la Gimkana Modernista</h1>
          <p class="subtitle">Actualització automàtica cada 5 segons · dades en temps real</p>
        </div>
      </div>
      <div style="display: flex; gap: 8px; align-items: center; margin-left: auto;">
        <div class="badge" id="last" style="margin:0;"></div>
        <button id="fullscreen-btn" class="badge" title="Pantalla completa"
          style="cursor:pointer; padding: 10px; line-height: 1;">
          <svg id="icon-fullscreen" width="17" height="17" viewBox="0 0 31.812 31.906" fill="currentColor"
            xmlns="http://www.w3.org/2000/svg">
            <path
              d="M31.728,31.291 C31.628,31.535 31.434,31.729 31.190,31.830 C31.069,31.881 30.940,31.907 30.811,31.907 L23.851,31.907 C23.301,31.907 22.856,31.461 22.856,30.910 C22.856,30.359 23.301,29.913 23.851,29.913 L28.405,29.908 L19.171,20.646 C18.782,20.257 18.782,19.626 19.171,19.236 C19.559,18.847 20.188,18.847 20.577,19.236 L29.906,28.593 L29.906,23.906 C29.906,23.355 30.261,22.933 30.811,22.933 C31.360,22.933 31.805,23.379 31.805,23.930 L31.805,30.910 C31.805,31.040 31.779,31.169 31.728,31.291 ZM30.811,8.973 C30.261,8.973 29.906,8.457 29.906,7.906 L29.906,3.313 L20.577,12.669 C20.382,12.864 20.128,12.962 19.874,12.962 C19.619,12.962 19.365,12.864 19.171,12.669 C18.782,12.280 18.782,11.649 19.171,11.259 L28.497,1.906 L23.906,1.906 C23.356,1.906 22.856,1.546 22.856,0.996 C22.856,0.445 23.301,-0.001 23.851,-0.001 L30.811,-0.001 C30.811,-0.001 30.811,-0.001 30.812,-0.001 C30.941,-0.001 31.069,0.025 31.190,0.076 C31.434,0.177 31.628,0.371 31.728,0.615 C31.779,0.737 31.805,0.866 31.805,0.996 L31.805,7.976 C31.805,8.526 31.360,8.973 30.811,8.973 ZM3.387,29.908 L7.942,29.913 C8.492,29.913 8.936,30.359 8.936,30.910 C8.936,31.461 8.492,31.907 7.942,31.907 L0.982,31.907 C0.853,31.907 0.724,31.881 0.602,31.830 C0.359,31.729 0.165,31.535 0.064,31.291 C0.014,31.169 -0.012,31.040 -0.012,30.910 L-0.012,23.930 C-0.012,23.379 0.433,22.933 0.982,22.933 C1.532,22.933 1.906,23.355 1.906,23.906 L1.906,28.573 L11.216,19.236 C11.605,18.847 12.234,18.847 12.622,19.236 C13.011,19.626 13.011,20.257 12.622,20.646 L3.387,29.908 ZM11.919,12.962 C11.665,12.962 11.410,12.864 11.216,12.669 L1.906,3.332 L1.906,7.906 C1.906,8.457 1.532,8.973 0.982,8.973 C0.433,8.973 -0.012,8.526 -0.012,7.976 L-0.012,0.996 C-0.012,0.866 0.014,0.737 0.064,0.615 C0.165,0.371 0.359,0.177 0.602,0.076 C0.723,0.025 0.852,-0.001 0.980,-0.001 C0.981,-0.001 0.981,-0.001 0.982,-0.001 L7.942,-0.001 C8.492,-0.001 8.936,0.445 8.936,0.996 C8.936,1.546 8.456,1.906 7.906,1.906 L3.296,1.906 L12.622,11.259 C13.011,11.649 13.011,12.280 12.622,12.669 C12.428,12.864 12.174,12.962 11.919,12.962 Z" />
          </svg>
          <svg id="icon-actualsize" width="17" height="17" viewBox="0 0 31.812 31.906" fill="var(--text)"
            xmlns="http://www.w3.org/2000/svg" class="hidden-icon">
            <path
              d="M23.263,9.969 L27.823,9.969 C28.372,9.969 28.817,10.415 28.817,10.966 C28.817,11.516 28.456,11.906 27.906,11.906 L21.154,11.906 C21.058,11.935 20.962,11.963 20.863,11.963 C20.608,11.963 20.354,11.865 20.160,11.671 C19.916,11.426 19.843,11.088 19.906,10.772 L19.906,3.906 C19.906,3.355 20.313,2.989 20.863,2.989 C21.412,2.989 21.857,3.435 21.857,3.986 L21.857,8.559 L30.103,0.289 C30.491,-0.100 31.120,-0.100 31.509,0.289 C31.897,0.679 31.897,1.310 31.509,1.699 L23.263,9.969 ZM11.914,27.917 C11.914,28.468 11.469,28.914 10.920,28.914 C10.370,28.914 9.926,28.468 9.926,27.917 L9.926,23.344 L1.680,31.613 C1.486,31.808 1.231,31.906 0.977,31.906 C0.723,31.906 0.468,31.808 0.274,31.613 C-0.114,31.224 -0.114,30.593 0.274,30.203 L8.520,21.934 L3.960,21.934 C3.410,21.934 2.966,21.488 2.966,20.937 C2.966,20.386 3.410,19.940 3.960,19.940 L10.920,19.940 C10.920,19.940 10.921,19.940 10.921,19.940 C11.050,19.940 11.179,19.967 11.300,20.017 C11.543,20.118 11.737,20.312 11.838,20.556 C11.888,20.678 11.914,20.807 11.914,20.937 L11.914,27.917 ZM10.920,11.963 C10.821,11.963 10.724,11.935 10.629,11.906 L3.906,11.906 C3.356,11.906 2.966,11.516 2.966,10.966 C2.966,10.415 3.410,9.969 3.960,9.969 L8.520,9.969 L0.274,1.699 C-0.114,1.310 -0.114,0.679 0.274,0.289 C0.662,-0.100 1.292,-0.100 1.680,0.289 L9.926,8.559 L9.926,3.986 C9.926,3.435 10.370,2.989 10.920,2.989 C11.469,2.989 11.914,3.435 11.914,3.986 L11.914,10.965 C11.914,11.221 11.817,11.476 11.623,11.671 C11.429,11.865 11.174,11.963 10.920,11.963 ZM20.174,20.222 C20.345,20.047 20.585,19.940 20.863,19.940 L27.823,19.940 C28.372,19.940 28.817,20.386 28.817,20.937 C28.817,21.488 28.372,21.934 27.823,21.934 L23.263,21.934 L31.509,30.203 C31.897,30.593 31.897,31.224 31.509,31.613 C31.314,31.808 31.060,31.906 30.806,31.906 C30.551,31.906 30.297,31.808 30.103,31.613 L21.857,23.344 L21.857,27.917 C21.857,28.468 21.412,28.914 20.863,28.914 C20.313,28.914 19.906,28.457 19.906,27.906 L19.906,21.130 C19.843,20.815 19.916,20.477 20.160,20.232 C20.164,20.228 20.170,20.227 20.174,20.222 Z" />
          </svg>
        </button>
      </div>
    </header>

    <main class="board">
      <section class="col">
        <div class="col-head">
          <span class="dot" style="background:var(--accent-3r)"></span>
          <div class="col-title">3r d'ESO</div>
        </div>
        <div id="col-3r" class="list"></div>
      </section>

      <section class="col">
        <div class="col-head">
          <span class="dot" style="background:var(--accent-4t)"></span>
          <div class="col-title">4t d'ESO</div>
        </div>
        <div id="col-4t" class="list"></div>
      </section>
    </main>

    <div id="error" class="error"></div>
  </div>

  <footer>
    <div>Aplicació creada per <a href="https://ja.cat/felipsarroca" target="_blank" rel="noopener">Felip Sarroca</a> amb
      l'assistència de la IA</div>
    <div>Obra sota llicència CC BY-NC-SA 4.0</div>
  </footer>

  <script>
    const QUERY_BASE = "https://docs.google.com/spreadsheets/d/11OBKW0XE1S5ia5H2BuIlr9TSexkS-tIsIyCH_TvogWU/gviz/tq?sheet=Classificacio";

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[m]));
    }

    const prevTop = { "3r": [], "4t": [] };

    function loadSheetData() {
      return new Promise((resolve, reject) => {
        const cbName = "gviz_cb_" + Date.now();
        window[cbName] = (resp) => {
          try {
            if (!resp || !resp.table) throw new Error("Resposta GViz buida");
            resolve(resp.table);
          } catch (err) {
            reject(err);
          } finally {
            delete window[cbName];
            script.remove();
          }
        };
        const url = `${QUERY_BASE}&tqx=responseHandler:${cbName};out:json`;
        const script = document.createElement("script");
        script.src = url;
        script.onerror = () => reject(new Error("No s'ha pogut carregar la graella (script)"));
        document.head.appendChild(script);
      });
    }

    function tableToLeader(table) {
      const cols = table.cols.map(c => (c.label || "").toLowerCase());
      const idxCurs = cols.indexOf("curs");
      const idxGrup = cols.indexOf("grup");
      const idxPunts = cols.indexOf("punts");
      if (idxCurs === -1 || idxGrup === -1 || idxPunts === -1) {
        throw new Error("Falten columnes Curs/Grup/Punts a la pestanya Classificacio");
      }
      const leader = {};
      (table.rows || []).forEach(r => {
        const curs = String(r.c[idxCurs]?.v ?? "").trim();
        const grup = String(r.c[idxGrup]?.v ?? "").trim();
        const punts = Number(r.c[idxPunts]?.v ?? 0);
        if (!curs || !grup || !punts) return;
        if (!leader[curs]) leader[curs] = [];
        leader[curs].push({ grup, punts });
      });
      Object.keys(leader).forEach(k => {
        leader[k].sort((a, b) => b.punts - a.punts);
      });
      return leader;
    }

    function renderColumn(id, items, accent, courseKey) {
      const host = document.getElementById(id);
      if (!host) return;
      const clean = (items || []).filter(x => Number(x.punts) > 0);
      if (!clean.length) {
        host.innerHTML = `<div class="empty">Encara no hi ha puntuacions.</div>`;
        return;
      }
      const max = Math.max(...clean.map(x => Number(x.punts) || 0));
      host.innerHTML = clean.map((x, i) => {
        const pct = max ? Math.round((Number(x.punts) || 0) / max * 100) : 0;
        const rankCls = i < 3 ? `border-color:${accent}; box-shadow:0 6px 20px ${accent}33;` : "";
        return `
          <div class="item" style="${i < 3 ? `background:linear-gradient(120deg, ${accent}1a, rgba(255,255,255,.04));` : ""}">
            <div class="rank" style="${rankCls}">${i + 1}</div>
            <div class="details">
              <div class="name">${escapeHtml(x.grup)}</div>
              <div class="bar"><div class="fill" style="width:${pct}%; background:linear-gradient(90deg, ${accent}, #ffffff80);"></div></div>
            </div>
            <div class="score"><span>${Number(x.punts)}</span><span class="pts">pts</span></div>
          </div>`;
      }).join("");

      highlightTopChanges(host, clean, courseKey, accent);
    }

    function highlightTopChanges(host, items, courseKey, accent) {
      if (!courseKey) return;
      const newTop = (items || []).slice(0, 3).map(x => `${x.grup}|${x.punts}`);
      const prev = prevTop[courseKey] || [];
      const changed = newTop.length !== prev.length || newTop.some((v, i) => v !== prev[i]);
      if (changed) {
        const leaderChanged = newTop[0] !== prev[0];
        if (leaderChanged) triggerConfetti(accent);
        const nodes = host.querySelectorAll(".item");
        nodes.forEach((node, idx) => {
          if (idx < 3) {
            node.classList.remove("pulse");
            void node.offsetWidth;
            node.style.setProperty("--pulse-color", accent);
            node.classList.add("pulse");
          }
        });
        prevTop[courseKey] = newTop;
      }
    }

    function triggerConfetti(color) {
      const colors = [color, "#ffffff", "#cde8ff"];
      for (let i = 0; i < 24; i++) {
        const piece = document.createElement("div");
        piece.className = "confetti";
        piece.style.background = colors[i % colors.length];
        piece.style.left = Math.random() * 100 + "vw";
        piece.style.setProperty("--x", (Math.random() * 60 - 30) + "px");
        piece.style.animationDuration = (0.9 + Math.random() * 0.5) + "s";
        piece.style.transform = `rotate(${Math.random() * 360}deg)`;
        document.body.appendChild(piece);
        setTimeout(() => piece.remove(), 1400);
      }
    }

    async function refresh() {
      document.getElementById("error").textContent = "";
      try {
        const table = await loadSheetData();
        const leader = tableToLeader(table);
        renderColumn("col-3r", leader["3r"] || [], "var(--accent-3r)", "3r");
        renderColumn("col-4t", leader["4t"] || [], "var(--accent-4t)", "4t");
        document.getElementById("last").innerHTML = "<i>Darrera actualització:</i> " + new Date().toLocaleTimeString();
      } catch (err) {
        document.getElementById("error").textContent = "Error en carregar les dades: " + (err?.message || err);
      }
    }

    refresh();
    setInterval(refresh, 5000);

    function toggleFullScreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          alert(`Error en intentar activar la pantalla completa: ${err.message} (${err.name})`);
        });
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        }
      }
    }

    function updateFullscreenIcons() {
      const iconFullscreen = document.getElementById('icon-fullscreen');
      const iconActualsize = document.getElementById('icon-actualsize');
      if (document.fullscreenElement) {
        iconFullscreen.classList.add('hidden-icon');
        iconActualsize.classList.remove('hidden-icon');
      } else {
        iconFullscreen.classList.remove('hidden-icon');
        iconActualsize.classList.add('hidden-icon');
      }
    }

    document.addEventListener('fullscreenchange', updateFullscreenIcons);
    document.getElementById('fullscreen-btn').addEventListener('click', toggleFullScreen);
    updateFullscreenIcons(); // Set initial state
  </script>
</body>

</html>
