<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panell de resultats de la Gimkana Modernista</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: radial-gradient(circle at 20% 20%, rgba(255,255,255,.08), transparent 30%), radial-gradient(circle at 80% 0%, rgba(255,255,255,.08), transparent 30%), linear-gradient(135deg, #0d1b2a, #0b2f53 60%, #103a4f);
      --card: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --text: #e9f0f7;
      --muted: #9ab3c9;
      --accent-3r: #3bd6c6;
      --accent-4t: #f2a93b;
      --shadow: 0 25px 50px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      color:var(--text);
      font-family:"Space Grotesk", system-ui, -apple-system, sans-serif;
      background:var(--bg);
      display:flex;
      flex-direction:column;
    }
    .page{
      flex:1;
      padding:32px clamp(16px, 4vw, 64px) 120px;
      position:relative;
      overflow:hidden;
    }
    .glow{
      position:absolute;
      inset:0;
      pointer-events:none;
      background:radial-gradient(circle at 30% 40%, rgba(59,214,198,.16), transparent 35%), radial-gradient(circle at 70% 20%, rgba(242,169,59,.16), transparent 30%);
      filter:blur(40px);
      z-index:0;
    }
    header{
      position:relative;
      z-index:1;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:18px;
      flex-wrap:wrap;
      margin-bottom:26px;
    }
    .eyebrow{
      text-transform:uppercase;
      letter-spacing:.16em;
      font-size:12px;
      color:var(--muted);
      margin:0 0 8px;
    }
    h1{
      margin:0;
      font-size: clamp(28px, 3.4vw, 44px);
      line-height:1.1;
    }
    .subtitle{
      margin:6px 0 0;
      color:var(--muted);
      font-size:16px;
    }
    .badge{
      background:rgba(255,255,255,.08);
      border:1px solid var(--border);
      padding:10px 14px;
      border-radius:999px;
      font-size:14px;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow:var(--shadow);
    }
    .board{
      position:relative;
      z-index:1;
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(320px, 1fr));
      gap:22px;
    }
    .col{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:22px;
      padding:18px 18px 12px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(8px);
    }
    .col-head{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    .dot{
      width:12px;height:12px;border-radius:50%;
      background:var(--muted);
      box-shadow:0 0 12px rgba(0,0,0,.25);
    }
    .col-title{
      font-size:20px;
      font-weight:700;
      letter-spacing:.02em;
    }
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      display:grid;
      grid-template-columns:48px 1fr auto;
      align-items:center;
      gap:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
    }
    .item.pulse{
      animation:pulseGlow 1.1s ease;
      position:relative;
    }
    .rank{
      width:38px;height:38px;
      display:grid;
      place-items:center;
      border-radius:12px;
      font-weight:700;
      font-size:16px;
      border:1px solid var(--border);
    }
    .details{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .name{
      font-weight:700;
      font-size:18px;
    }
    .bar{
      position:relative;
      width:100%;
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.1);
      overflow:hidden;
    }
    .fill{
      position:absolute;
      inset:0;
      width:0;
      border-radius:999px;
      background:linear-gradient(90deg, rgba(255,255,255,.7), rgba(255,255,255,.4));
      transform-origin:left;
      transition:width .6s ease;
    }
    @keyframes pulseGlow{
      0%{box-shadow:0 0 0 0 var(--pulse-color, rgba(255,255,255,.6)); transform:translateY(0);}
      50%{box-shadow:0 0 0 18px transparent; transform:translateY(-4px);}
      100%{box-shadow:0 0 0 0 transparent; transform:translateY(0);}
    }
    .score{
      font-weight:700;
      font-size:18px;
      min-width:80px;
      text-align:right;
    }
    .gain{
      display:inline-block;
      margin-top:4px;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(255,255,255,.12);
      color:var(--text);
      font-size:12px;
      font-weight:700;
      animation:popIn .8s ease;
    }
    @keyframes popIn{
      0%{transform:translateY(6px) scale(.9); opacity:0;}
      60%{transform:translateY(0) scale(1.02); opacity:1;}
      100%{transform:translateY(0) scale(1); opacity:1;}
    }
    .confetti{
      position:fixed;
      top:-20px;
      width:10px;
      height:18px;
      opacity:0.9;
      border-radius:3px;
      animation:confettiFall 1.2s ease-out forwards;
      pointer-events:none;
      z-index:5;
    }
    @keyframes confettiFall{
      0%{transform:translate3d(var(--x,0),0,0) rotate(0deg);}
      100%{transform:translate3d(var(--x,0),110vh,0) rotate(320deg);}
      to{opacity:0;}
    }
    .empty{
      color:var(--muted);
      font-size:14px;
      padding:6px 12px;
    }
    .error{
      color:#ffb4b4;
      margin-top:16px;
      white-space:pre-wrap;
      font-size:14px;
    }
    footer{
      position:fixed;
      bottom:0;left:0;right:0;
      padding:12px 20px;
      background:rgba(12,20,34,.9);
      color:var(--muted);
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:13px;
      border-top:1px solid var(--border);
      backdrop-filter:blur(6px);
    }
    footer a{color:var(--text);text-decoration:none;font-weight:700;}
    @media (max-width:720px){
      .item{grid-template-columns:40px 1fr;}
      .score{justify-self:end;}
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="glow"></div>
    <header>
      <div>
        <p class="eyebrow">gimkana en directe</p>
        <h1>Panell de resultats de la Gimkana Modernista</h1>
        <p class="subtitle">Actualització automàtica cada 5 segons · dades en temps real</p>
      </div>
      <div class="badge" id="last">Esperant dades…</div>
    </header>

    <main class="board">
      <section class="col">
        <div class="col-head">
          <span class="dot" style="background:var(--accent-3r)"></span>
          <div class="col-title">3r d'ESO</div>
        </div>
        <div id="col-3r" class="list"></div>
      </section>

      <section class="col">
        <div class="col-head">
          <span class="dot" style="background:var(--accent-4t)"></span>
          <div class="col-title">4t d'ESO</div>
        </div>
        <div id="col-4t" class="list"></div>
      </section>
    </main>

    <div id="error" class="error"></div>
  </div>

  <footer>
    <div>Aplicació creada per <a href="https://ja.cat/felipsarroca" target="_blank" rel="noopener">Felip Sarroca</a> amb l'assistència de la IA</div>
    <div>Obra sota llicència CC BY-NC-SA 4.0</div>
  </footer>

  <script>
    // Configura aquí la teva graella (compartida "qualsevol amb l'enllaç pot veure")
    // Fem servir GViz en mode JSONP per evitar CORS.
    const QUERY_BASE = "https://docs.google.com/spreadsheets/d/11OBKW0XE1S5ia5H2BuIlr9TSexkS-tIsIyCH_TvogWU/gviz/tq?sheet=Classificacio";

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    const prevTop = { "3r": [], "4t": [] };
    const prevPoints = { "3r": {}, "4t": {} };

    function loadSheetData(){
      return new Promise((resolve, reject)=>{
        const cbName = "gviz_cb_" + Date.now();
        window[cbName] = (resp)=>{
          try{
            if (!resp || !resp.table) throw new Error("Resposta GViz buida");
            resolve(resp.table);
          } catch(err){
            reject(err);
          } finally {
            delete window[cbName];
            script.remove();
          }
        };
        const url = `${QUERY_BASE}&tqx=responseHandler:${cbName};out:json`;
        const script = document.createElement("script");
        script.src = url;
        script.onerror = ()=> reject(new Error("No s'ha pogut carregar la graella (script)"));
        document.head.appendChild(script);
      });
    }

    function tableToLeader(table){
      const cols = table.cols.map(c => (c.label || "").toLowerCase());
      const idxCurs = cols.indexOf("curs");
      const idxGrup = cols.indexOf("grup");
      const idxPunts = cols.indexOf("punts");
      if (idxCurs === -1 || idxGrup === -1 || idxPunts === -1){
        throw new Error("Falten columnes Curs/Grup/Punts a la pestanya Classificacio");
      }
      const leader = {};
      (table.rows || []).forEach(r => {
        const curs = String(r.c[idxCurs]?.v ?? "").trim();
        const grup = String(r.c[idxGrup]?.v ?? "").trim();
        const punts = Number(r.c[idxPunts]?.v ?? 0);
        if (!curs || !grup || !punts) return;
        if (!leader[curs]) leader[curs] = [];
        leader[curs].push({ grup, punts });
      });
      Object.keys(leader).forEach(k => {
        leader[k].sort((a,b)=> b.punts - a.punts);
      });
      return leader;
    }

    function renderColumn(id, items, accent, courseKey){
      const host = document.getElementById(id);
      if (!host) return;
      const clean = (items || []).filter(x => Number(x.punts) > 0);
      if (!clean.length){
        host.innerHTML = `<div class="empty">Encara no hi ha puntuacions.</div>`;
        return;
      }
      const prevMap = prevPoints[courseKey] || {};
      const max = Math.max(...clean.map(x => Number(x.punts) || 0));
      host.innerHTML = clean.map((x, i) => {
        const pct = max ? Math.round((Number(x.punts) || 0) / max * 100) : 0;
        const rankCls = i < 3 ? `border-color:${accent}; box-shadow:0 6px 20px ${accent}33;` : "";
        const diff = (Number(x.punts) || 0) - (prevMap[x.grup] || 0);
        const gain = diff > 0 ? `<span class="gain">+${diff} punts</span>` : "";
        return `
          <div class="item" style="${i < 3 ? `background:linear-gradient(120deg, ${accent}1a, rgba(255,255,255,.04));` : ""}">
            <div class="rank" style="${rankCls}">${i + 1}</div>
            <div class="details">
              <div class="name">${escapeHtml(x.grup)}</div>
              <div class="bar"><div class="fill" style="width:${pct}%; background:linear-gradient(90deg, ${accent}, #ffffff80);"></div></div>
              ${gain}
            </div>
            <div class="score">${Number(x.punts)} pts</div>
          </div>`;
      }).join("");

      const map = {};
      clean.forEach(x => { map[x.grup] = Number(x.punts) || 0; });
      prevPoints[courseKey] = map;

      highlightTopChanges(host, clean, courseKey, accent);
    }

    function highlightTopChanges(host, items, courseKey, accent){
      if (!courseKey) return;
      const newTop = (items || []).slice(0,3).map(x => `${x.grup}|${x.punts}`);
      const prev = prevTop[courseKey] || [];
      const changed = newTop.length !== prev.length || newTop.some((v,i) => v !== prev[i]);
      if (changed){
        const leaderChanged = newTop[0] !== prev[0];
        if (leaderChanged) triggerConfetti(accent);
        const nodes = host.querySelectorAll(".item");
        nodes.forEach((node, idx) => {
          if (idx < 3){
            node.classList.remove("pulse");
            // restart animation
            void node.offsetWidth;
            node.style.setProperty("--pulse-color", accent);
            node.classList.add("pulse");
          }
        });
        prevTop[courseKey] = newTop;
      }
    }

    function triggerConfetti(color){
      const colors = [color, "#ffffff", "#cde8ff"];
      for (let i = 0; i < 24; i++){
        const piece = document.createElement("div");
        piece.className = "confetti";
        piece.style.background = colors[i % colors.length];
        piece.style.left = Math.random()*100 + "vw";
        piece.style.setProperty("--x", (Math.random()*60 - 30) + "px");
        piece.style.animationDuration = (0.9 + Math.random()*0.5) + "s";
        piece.style.transform = `rotate(${Math.random()*360}deg)`;
        document.body.appendChild(piece);
        setTimeout(()=> piece.remove(), 1400);
      }
    }

    async function refresh(){
      document.getElementById("error").textContent = "";
      try{
        const table = await loadSheetData();
        const leader = tableToLeader(table);
        renderColumn("col-3r", leader["3r"] || [], "var(--accent-3r)", "3r");
        renderColumn("col-4t", leader["4t"] || [], "var(--accent-4t)", "4t");
        document.getElementById("last").textContent = "Darrera actualització: " + new Date().toLocaleTimeString();
      } catch(err){
        document.getElementById("error").textContent = "Error en carregar les dades: " + (err?.message || err);
      }
    }

    refresh();
    setInterval(refresh, 5000);
  </script>
</body>
</html>
